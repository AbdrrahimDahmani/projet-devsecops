name: DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # ==================== BUILD & TEST ====================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build and test api-gateway
        run: |
          cd api-gateway
          chmod +x mvnw 2>/dev/null || true
          mvn clean verify -B

      - name: Build and test order-service
        run: |
          cd order-service
          chmod +x mvnw 2>/dev/null || true
          mvn clean verify -B

      - name: Build and test product-service
        run: |
          cd product-service
          chmod +x mvnw 2>/dev/null || true
          mvn clean verify -B

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: java-artifacts
          path: |
            api-gateway/target/*.jar
            order-service/target/*.jar
            product-service/target/*.jar
          retention-days: 1

  # ==================== OWASP DEPENDENCY CHECK ====================
  owasp-dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Check NVD API Key
        run: |
          if [ -z "${{ secrets.NVD_API_KEY }}" ]; then
            echo "âš ï¸ WARNING: NVD_API_KEY secret is not set!"
            echo "Get a free API key at: https://nvd.nist.gov/developers/request-an-api-key"
            echo "Then add it as a repository secret named NVD_API_KEY"
          else
            echo "âœ… NVD API Key is configured"
          fi

      - name: Run OWASP Dependency-Check on api-gateway
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          cd api-gateway
          if [ -n "$NVD_API_KEY" ]; then
            mvn org.owasp:dependency-check-maven:check -Dnvd.api.key="$NVD_API_KEY" -DfailBuildOnCVSS=9 -DsuppressionFiles=../owasp-suppressions.xml
          else
            echo "Skipping OWASP check - NVD API Key not configured"
          fi

      - name: Run OWASP Dependency-Check on order-service
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          cd order-service
          if [ -n "$NVD_API_KEY" ]; then
            mvn org.owasp:dependency-check-maven:check -Dnvd.api.key="$NVD_API_KEY" -DfailBuildOnCVSS=9 -DsuppressionFiles=../owasp-suppressions.xml
          else
            echo "Skipping OWASP check - NVD API Key not configured"
          fi

      - name: Run OWASP Dependency-Check on product-service
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          cd product-service
          if [ -n "$NVD_API_KEY" ]; then
            mvn org.owasp:dependency-check-maven:check -Dnvd.api.key="$NVD_API_KEY" -DfailBuildOnCVSS=9 -DsuppressionFiles=../owasp-suppressions.xml
          else
            echo "Skipping OWASP check - NVD API Key not configured"
          fi

      - name: Upload OWASP reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-reports
          path: |
            */target/dependency-check-report.html
          retention-days: 5

  # ==================== SONARQUBE ANALYSIS ====================
  sonarqube-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build Java services
        run: |
          mvn -f api-gateway/pom.xml compile -DskipTests
          mvn -f order-service/pom.xml compile -DskipTests
          mvn -f product-service/pom.xml compile -DskipTests

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=abdrrahimdahmani
            -Dsonar.projectKey=AbdrrahimDahmani_projet-devsecops
            -Dsonar.qualitygate.wait=true
            -Dsonar.qualitygate.timeout=300

  # ==================== BUILD DOCKER IMAGES ====================
  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Package Java services
        run: |
          mvn -f api-gateway/pom.xml package -DskipTests
          mvn -f order-service/pom.xml package -DskipTests
          mvn -f product-service/pom.xml package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build api-gateway image
        uses: docker/build-push-action@v5
        with:
          context: ./api-gateway
          push: false
          tags: api-gateway:${{ github.sha }}
          load: true

      - name: Build order-service image
        uses: docker/build-push-action@v5
        with:
          context: ./order-service
          push: false
          tags: order-service:${{ github.sha }}
          load: true

      - name: Build product-service image
        uses: docker/build-push-action@v5
        with:
          context: ./product-service
          push: false
          tags: product-service:${{ github.sha }}
          load: true

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          tags: frontend:${{ github.sha }}
          load: true

      - name: Save Docker images
        run: |
          docker save api-gateway:${{ github.sha }} -o api-gateway.tar
          docker save order-service:${{ github.sha }} -o order-service.tar
          docker save product-service:${{ github.sha }} -o product-service.tar
          docker save frontend:${{ github.sha }} -o frontend.tar

      - name: Upload Docker images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: |
            api-gateway.tar
            order-service.tar
            product-service.tar
            frontend.tar
          retention-days: 1

  # ==================== TRIVY SECURITY SCAN ====================
  trivy-security-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    needs: [owasp-dependency-check, build-docker-images]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load Docker images
        run: |
          docker load -i api-gateway.tar
          docker load -i order-service.tar
          docker load -i product-service.tar
          docker load -i frontend.tar

      - name: Scan api-gateway image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "api-gateway:${{ github.sha }}"
          format: "table"
          exit-code: "0"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

      - name: Scan order-service image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "order-service:${{ github.sha }}"
          format: "table"
          exit-code: "0"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

      - name: Scan product-service image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "product-service:${{ github.sha }}"
          format: "table"
          exit-code: "0"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

      - name: Scan frontend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "frontend:${{ github.sha }}"
          format: "table"
          exit-code: "0"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

      - name: Filesystem vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  # ==================== SECURITY SUMMARY ====================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [sonarqube-analysis, trivy-security-scan]
    if: always()
    steps:
      - name: Download OWASP reports
        uses: actions/download-artifact@v4
        with:
          name: owasp-reports
          path: owasp-reports
        continue-on-error: true

      - name: Generate Security Summary
        run: |
          echo "# ðŸ”’ DevSecOps Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Build & Test | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” OWASP Dependency Check | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š SonarQube Analysis | ${{ needs.sonarqube-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker Image Build | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Trivy Security Scan | ${{ needs.trivy-security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Dependency Check reports available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy results uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          echo "- SonarCloud results: [View Dashboard](https://sonarcloud.io/project/overview?id=AbdrrahimDahmani_projet-devsecops)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• Pipeline completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
